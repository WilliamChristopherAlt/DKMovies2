@model DKMovies.Models.ShowTime
@{
    ViewData["Title"] = "Edit Showtime";
    var theaters = ViewBag.Theaters as List<DKMovies.Models.Theater> ?? new List<DKMovies.Models.Theater>();
    int selectedTheaterId = ViewBag.SelectedTheaterID ?? 0;
}

<h1 class="mb-4">✏️ Edit Showtime</h1>

<div class="shadow-sm p-4 bg-light rounded">
    <form asp-action="Edit">
        <input type="hidden" asp-for="ID" />
        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

        <div class="mb-3">
            <label class="form-label">🏛 Theater</label>
            <select id="TheaterID" name="TheaterID" class="form-select" asp-items="ViewBag.Theaters">
                <option value="">-- Select Theater --</option>
            </select>

        </div>

        <div class="mb-3">
            <label asp-for="AuditoriumID" class="form-label"></label>
            <select asp-for="AuditoriumID" class="form-select" id="AuditoriumID">
                <option value="">-- Select Auditorium --</option>
            </select>
            <span asp-validation-for="AuditoriumID" class="text-danger small"></span>
        </div>

        <div class="mb-3">
            <label asp-for="MovieID" class="form-label"></label>
            <select asp-for="MovieID" class="form-select" asp-items="ViewBag.MovieID"></select>
            <span asp-validation-for="MovieID" class="text-danger small"></span>
        </div>

        <div class="mb-3">
            <label asp-for="StartTime" class="form-label"></label>
            <input asp-for="StartTime" class="form-control" type="datetime-local" />
            <span asp-validation-for="StartTime" class="text-danger small"></span>
        </div>

        <div class="mb-3">
            <label asp-for="DurationMinutes" class="form-label"></label>
            <input asp-for="DurationMinutes" class="form-control" />
            <span asp-validation-for="DurationMinutes" class="text-danger small"></span>
        </div>

        <div class="mb-3">
            <label asp-for="SubtitleLanguageID" class="form-label"></label>
            <select asp-for="SubtitleLanguageID" class="form-select" asp-items="ViewBag.LanguageID"></select>
            <span asp-validation-for="SubtitleLanguageID" class="text-danger small"></span>
        </div>

        <div class="form-check mb-3">
            <input asp-for="Is3D" class="form-check-input" />
            <label asp-for="Is3D" class="form-check-label"></label>
        </div>

        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Save</button>
            <a asp-action="Index" class="btn btn-outline-secondary">Cancel</a>
        </div>
    </form>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
    <script>
        $(document).ready(function () {
            const selectedAuditorium = '@Model.AuditoriumID';

            function loadAuditoriums(theaterId) {
                const auditoriumDropdown = $('#AuditoriumID');
                auditoriumDropdown.html('<option>Loading...</option>');
                if (theaterId) {
                    $.get('@Url.Action("GetAuditoriumsByTheater", "ShowTimes")', { theaterId }, function (data) {
                        auditoriumDropdown.empty();
                        auditoriumDropdown.append('<option value="">-- Select Auditorium --</option>');
                        data.forEach(a => {
                            const selected = a.id == selectedAuditorium ? 'selected' : '';
                            auditoriumDropdown.append(`<option value="${a.id}" ${selected}>${a.name}</option>`);
                        });
                    });
                } else {
                    auditoriumDropdown.html('<option value="">-- Select Auditorium --</option>');
                }
            }

            const currentTheaterId = $('#TheaterID').val();
            if (currentTheaterId) {
                loadAuditoriums(currentTheaterId);
            }

            $('#TheaterID').change(function () {
                loadAuditoriums($(this).val());
            });
        });
    </script>
}
